<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Shop Dashboard — Nashville</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --top-percent: 75vh;   /* top area height (sheet/slides/video) */
      --bottom-percent: calc(100vh - var(--top-percent));
    }
    html, body { height: 100%; margin: 0; background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { height: 100vh; width: 100vw; display: grid; grid-template-rows: var(--top-percent) var(--bottom-percent); }

    /* TOP container holds three panes, we toggle them */
    #topBox { position: relative; background:#000; overflow:hidden; }
    .pane   { position:absolute; inset:0; }
    .hidden { display:none; }

    /* Iframes */
    iframe { border:0; width:100%; height:100%; background:#000; }

    /* BOTTOM: Custom 7-day forecast */
    #weather { background:#0b0b0b; height:100%; width:100%; display:grid; grid-template-columns: repeat(7, 1fr); gap:0; }
    .day {
      display:grid; grid-template-rows: 0.5fr 1.1fr 0.8fr 0.6fr; /* DOW / icon / hi / lo */
      align-items:center; justify-items:center; height:100%;
      border-left: 1px solid rgba(255,255,255,0.08);
    }
    .day:first-child { border-left:none; }
    .dow { font-size: 0.95rem; opacity: 0.9; margin-top: 2px; }
    .icon { font-size: 1.8rem; line-height: 1; }
    .hi   { font-size: 1.2rem; font-weight: 700; }
    .lo   { font-size: 0.95rem; opacity: 0.9; margin-bottom: 4px; }
    .hi.hot  { color:#ff6b6b; }   /* 90+ */
    .hi.warm { color:#ffa94d; }   /* 80-89 */
    .hi.cool { color:#4dabf7; }   /* below 80 */

    ::-webkit-scrollbar { width:0; height:0; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- TOP: Sheet + Slides + Video (we rotate these) -->
    <div id="topBox">
      <!-- SHEET -->
      <div id="paneSheet" class="pane">
        <iframe
          id="sheet"
          sandbox="allow-scripts allow-same-origin allow-forms allow-presentation"
          src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSBrgvQHdcw5mVUfRSSewO0BQ3pNcbL2WAAb5WshzX1LVv0Ht2TVnMSyp5WME5oiTvBrsrVN2wtrfE8/pubhtml?gid=0&single=true">
        </iframe>
      </div>

      <!-- SLIDES (Publish to web → Link; autoplay/loop; rm=minimal) -->
      <div id="paneSlides" class="pane hidden">
        <iframe
          id="slides"
          allow="autoplay"
          sandbox="allow-scripts allow-same-origin allow-presentation"
          src="https://docs.google.com/presentation/d/e/2PACX-1vT-muvXcDisu2bLfnI0QWZAkxD-F5Lrt2KmlAIh2J6j7mlsq0rsmy8DF1F9lyogH_x_HLvThveNmRKg/pub?start=true&loop=true&delayms=7000&rm=minimal">
        </iframe>
      </div>

      <!-- VIDEO (YouTube, controlled via IFrame API) -->
      <div id="paneVideo" class="pane hidden">
        <iframe
          id="yt"
          allow="autoplay; encrypted-media; fullscreen; picture-in-picture"
          sandbox="allow-scripts allow-same-origin allow-presentation"
          referrerpolicy="no-referrer-when-downgrade"
          src="">
        </iframe>
      </div>
    </div>

    <!-- BOTTOM: Native 7-day forecast (Open-Meteo) -->
    <div id="weather" aria-label="7-day weather for Nashville, TN"></div>
  </div>

  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    /******** CONFIG ********/
    // Slides already set in the iframe above.
    // YouTube video (use your DADU project):
    const YT_VIDEO_ID = "jGJiMJ_T8Ow";
    // Rotation order & durations
    const DUR = { sheet: 45_000, slides: 45_000, videoMax: 55_000 }; // fallback cap for video
    const ORDER = ["sheet","slides","sheet","video"]; // repeat

    // Optional: refresh the Sheet iframe every 5 minutes
    const SHEET_REFRESH_MS = 5 * 60 * 1000;

    /******** ELEMENTS ********/
    const paneSheet  = document.getElementById('paneSheet');
    const paneSlides = document.getElementById('paneSlides');
    const paneVideo  = document.getElementById('paneVideo');
    const sheetIF    = document.getElementById('sheet');
    const slidesIF   = document.getElementById('slides');
    const ytIF       = document.getElementById('yt');

    // Build a safe nocookie URL with your current origin for JS API control
    const ORIGIN = encodeURIComponent(location.origin);
    const YT_URL = `https://www.youtube-nocookie.com/embed/${YT_VIDEO_ID}?enablejsapi=1&autoplay=0&mute=1&controls=0&modestbranding=1&rel=0&playsinline=1&fs=0&origin=${ORIGIN}`;
    ytIF.src = YT_URL;

    /******** YOUTUBE CONTROL ********/
    let ytPlayer = null, ytReady = false, cycleTimer = null, stepIndex = 0, videoCapTimer = null;

    window.onYouTubeIframeAPIReady = function(){
      ytPlayer = new YT.Player('yt', {
        events: {
          onReady: () => { ytReady = true; },
          onStateChange: (e) => {
            // If video ended, advance immediately
            if (e.data === YT.PlayerState.ENDED) {
              if (videoCapTimer) { clearTimeout(videoCapTimer); videoCapTimer = null; }
              nextStep();
            }
          }
        }
      });
    };

    function showPane(name){
      paneSheet .classList.toggle('hidden', name !== 'sheet');
      paneSlides.classList.toggle('hidden', name !== 'slides');
      paneVideo .classList.toggle('hidden', name !== 'video');

      if (name === 'video' && ytReady) {
        try {
          ytPlayer.mute();                // reliable autoplay on TV sticks
          ytPlayer.seekTo(0, true);
          ytPlayer.playVideo();
        } catch(_) {}
      } else if (ytReady) {
        try { ytPlayer.pauseVideo(); } catch(_) {}
      }
    }

    function scheduleNext(ms){
      clearTimeout(cycleTimer);
      cycleTimer = setTimeout(nextStep, ms);
    }

    function nextStep(){
      stepIndex = (stepIndex + 1) % ORDER.length;
      const name = ORDER[stepIndex];
      showPane(name);

      if (name === 'video') {
        // Advance on end; but cap duration so we never get stuck
        if (videoCapTimer) clearTimeout(videoCapTimer);
        videoCapTimer = setTimeout(() => {
          // If player didn't report END (network hiccup), move on anyway
          nextStep();
        }, DUR.videoMax);
      } else {
        scheduleNext(name === 'sheet' ? DUR.sheet : DUR.slides);
      }
    }

    // Start flow
    showPane('sheet');
    scheduleNext(DUR.sheet);

    // Keep the sheet fresh
    if (SHEET_REFRESH_MS > 0) {
      setInterval(() => { sheetIF.src = sheetIF.src; }, SHEET_REFRESH_MS);
    }

    /******** WEATHER: Nashville via Open-Meteo (no API key) ********/
    const LAT = 36.1627, LON = -86.7816, TZ = 'America/Chicago';
    const UNITS = 'fahrenheit';
    const WIND  = 'mph';
    const REFRESH_MS = 30 * 60 * 1000;

    const weatherEl = document.getElementById('weather');
    const WMO_MAP = [
      {codes:[0], i:'☀️', t:'Clear'},
      {codes:[1,2], i:'🌤️', t:'Partly cloudy'},
      {codes:[3], i:'☁️', t:'Overcast'},
      {codes:[45,48], i:'🌫️', t:'Fog'},
      {codes:[51,53,55], i:'🌦️', t:'Drizzle'},
      {codes:[56,57], i:'🌧️', t:'Freezing drizzle'},
      {codes:[61,63,65], i:'🌧️', t:'Rain'},
      {codes:[66,67], i:'🌧️', t:'Freezing rain'},
      {codes:[71,73,75,77], i:'❄️', t:'Snow'},
      {codes:[80,81,82], i:'🌦️', t:'Showers'},
      {codes:[85,86], i:'❄️', t:'Snow showers'},
      {codes:[95], i:'⛈️', t:'Thunderstorm'},
      {codes:[96,99], i:'⛈️', t:'Thunderstorm w/ hail'},
    ];
    function iconFor(code){ for (const g of WMO_MAP) if (g.codes.includes(code)) return g.i; return '❓'; }
    function hiClass(t){ return t>=90?'hot':t>=80?'warm':'cool'; }
    function dowLabel(s){ return new Date(s+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',timeZone:TZ}); }

    async function loadForecast(){
      try{
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}`
          + `&daily=weathercode,temperature_2m_max,temperature_2m_min`
          + `&temperature_unit=${UNITS}&windspeed_unit=${WIND}&timezone=${encodeURIComponent(TZ)}`;
        const res = await fetch(url);
        const data = await res.json();
        const days = data.daily.time.length;

        weatherEl.innerHTML = '';
        for (let i=0; i<Math.min(7, days); i++){
          const code = data.daily.weathercode[i];
          const hi   = Math.round(data.daily.temperature_2m_max[i]);
          const lo   = Math.round(data.daily.temperature_2m_min[i]);
          const day  = dowLabel(data.daily.time[i]);

          const tile = document.createElement('div');
          tile.className = 'day';
          tile.innerHTML = `
            <div class="dow" title="${day}">${day}</div>
            <div class="icon" title="${code}">${iconFor(code)}</div>
            <div class="hi ${hiClass(hi)}">${hi}°</div>
            <div class="lo">${lo}°</div>
          `;
          weatherEl.appendChild(tile);
        }
      }catch(e){
        weatherEl.innerHTML = '<div style="grid-column:1/-1;display:flex;align-items:center;justify-content:center;font-size:1.2rem;opacity:.8;">Weather unavailable</div>';
        console.error(e);
      }
    }
    loadForecast();
    setInterval(loadForecast, REFRESH_MS);
  </script>
</body>
</html>
