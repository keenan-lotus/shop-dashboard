<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Shop Dashboard — Nashville</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* Adjust the split here if you want more/less weather space */
      --top-percent: 75vh;   /* top area height (sheet/slides/video) */
      --bottom-percent: calc(100vh - var(--top-percent)); /* weather auto-fills rest */
    }
    html, body { height: 100%; margin: 0; background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { height: 100vh; width: 100vw; display: grid; grid-template-rows: var(--top-percent) var(--bottom-percent); }

    /* TOP container holds panes, we toggle them */
    #sheetBox { position: relative; background:#000; overflow:hidden; }
    .pane { position:absolute; inset:0; }
    .hidden { display:none; }

    /* Iframes */
    iframe { border:0; width:100%; height:100%; background:#000; }

    /* BOTTOM: Custom 7-day forecast */
    #weather { background:#0b0b0b; height:100%; width:100%; display:grid; grid-template-columns: repeat(7, 1fr); gap:0; }
    .day {
      display:grid; grid-template-rows: 0.5fr 1.1fr 0.8fr 0.6fr; /* DOW / icon / hi / lo */
      align-items:center; justify-items:center; height:100%;
      border-left: 1px solid rgba(255,255,255,0.08);
    }
    .day:first-child { border-left:none; }
    .dow { font-size: 0.95rem; opacity: 0.9; margin-top: 2px; }
    .icon { font-size: 1.8rem; line-height: 1; }
    .hi   { font-size: 1.2rem; font-weight: 700; }
    .lo   { font-size: 0.95rem; opacity: 0.9; margin-bottom: 4px; }

    .hi.hot    { color:#ff6b6b; }   /* 90+ */
    .hi.warm   { color:#ffa94d; }   /* 80-89 */
    .hi.cool   { color:#4dabf7; }   /* below 80 */

    ::-webkit-scrollbar { width:0; height:0; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- TOP: Sheet pane + Slides pane + Video pane (we rotate them) -->
    <div id="sheetBox">
      <!-- Sheet -->
      <div id="paneSheet" class="pane">
        <iframe
          id="sheet"
          sandbox="allow-scripts allow-same-origin allow-forms allow-presentation"
          src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSBrgvQHdcw5mVUfRSSewO0BQ3pNcbL2WAAb5WshzX1LVv0Ht2TVnMSyp5WME5oiTvBrsrVN2wtrfE8/pubhtml?gid=0&single=true">
        </iframe>
      </div>

      <!-- Slides -->
      <div id="paneSlides" class="pane hidden">
        <!-- Your working Publish-to-web link (unchanged behavior) -->
        <iframe
          id="slides"
          allow="autoplay"
          sandbox="allow-scripts allow-same-origin allow-presentation">
        </iframe>
      </div>

      <!-- Video (YouTube, muted autoplay) -->
      <div id="paneVideo" class="pane hidden">
        <iframe
          id="video"
          allow="autoplay; encrypted-media; fullscreen; picture-in-picture"
          sandbox="allow-scripts allow-same-origin allow-presentation">
        </iframe>
      </div>
    </div>

    <!-- BOTTOM: Native 7-day forecast (Open-Meteo) -->
    <div id="weather" aria-label="7-day weather for Nashville, TN"></div>
  </div>

  <script>
    /******** CONFIG ********/
    // Slides (keep exactly as you had; we’ll reload it with a cache-buster each time it shows)
    const SLIDES_URL = "https://docs.google.com/presentation/d/e/2PACX-1vT-muvXcDisu2bLfnI0QWZAkxD-F5Lrt2KmlAIh2J6j7mlsq0rsmy8DF1F9lyogH_x_HLvThveNmRKg/pubembed?start=false&loop=false&delayms=5000&rm=minimal";

    // YouTube video (muted autoplay) — your DADU project
    const YT_ID = "jGJiMJ_T8Ow";
    const YT_URL_BASE = `https://www.youtube-nocookie.com/embed/${YT_ID}?autoplay=1&mute=1&controls=0&modestbranding=1&rel=0&playsinline=1&fs=0`;

    // Rotation timing (ms)
    const DURATIONS = { sheet: 45 * 1000, slides: 45 * 1000, video: 55 * 1000 }; // ~50s video, give it 55s
    const ORDER = ["sheet", "slides", "video"]; // Spreadsheet → Slides → Video → repeat

    // Optional: refresh the Sheet iframe every 5 minutes to keep it fresh
    const SHEET_REFRESH_MS = 5 * 60 * 1000;

    /******** ELEMENTS ********/
    const paneSheet  = document.getElementById('paneSheet');
    const paneSlides = document.getElementById('paneSlides');
    const paneVideo  = document.getElementById('paneVideo');
    const sheetIF    = document.getElementById('sheet');
    const slidesIF   = document.getElementById('slides');
    const videoIF    = document.getElementById('video');

    let step = 0, timer = null;

    function show(name){
      // Toggle panes
      paneSheet .classList.toggle('hidden', name !== 'sheet');
      paneSlides.classList.toggle('hidden', name !== 'slides');
      paneVideo .classList.toggle('hidden', name !== 'video');

      const ts = Date.now();       // cache-buster to keep autoplay happy on Silk
      if (name === 'sheet') {
        // stop other iframes to save CPU / avoid audio surprises
        slidesIF.src = 'about:blank';
        videoIF.src  = 'about:blank';
      }
      if (name === 'slides') {
        videoIF.src  = 'about:blank';
        const sep = SLIDES_URL.includes('?') ? '&' : '?';
        slidesIF.src = SLIDES_URL + sep + 'ts=' + ts;
      }
      if (name === 'video') {
        slidesIF.src = 'about:blank';
        const sep = YT_URL_BASE.includes('?') ? '&' : '?';
        // Start from the beginning each time, muted autoplay
        videoIF.src  = YT_URL_BASE + sep + 'start=0&ts=' + ts;
      }
    }

    function scheduleNext(){
      const name = ORDER[step % ORDER.length];
      show(name);
      clearTimeout(timer);
      timer = setTimeout(() => {
        step++;
        scheduleNext();
      }, DURATIONS[name]);
    }

    // Start on sheet
    scheduleNext();

    // Keep the Sheet fresh
    if (SHEET_REFRESH_MS > 0) {
      setInterval(() => { sheetIF.src = sheetIF.src; }, SHEET_REFRESH_MS);
    }

    /******** WEATHER: Nashville via Open-Meteo (no API key) ********/
    const LAT = 36.1627, LON = -86.7816, TZ = 'America/Chicago';
    const UNITS = 'fahrenheit'; // 'fahrenheit' or 'celsius'
    const WIND  = 'mph';        // mph, kmh, ms, kn
    const REFRESH_MS = 30 * 60 * 1000; // re-fetch every 30 min

    const weatherEl = document.getElementById('weather');

    const WMO_MAP = [
      {codes:[0], i:'☀️', t:'Clear'},
      {codes:[1,2], i:'🌤️', t:'Partly cloudy'},
      {codes:[3], i:'☁️', t:'Overcast'},
      {codes:[45,48], i:'🌫️', t:'Fog'},
      {codes:[51,53,55], i:'🌦️', t:'Drizzle'},
      {codes:[56,57], i:'🌧️', t:'Freezing drizzle'},
      {codes:[61,63,65], i:'🌧️', t:'Rain'},
      {codes:[66,67], i:'🌧️', t:'Freezing rain'},
      {codes:[71,73,75,77], i:'❄️', t:'Snow'},
      {codes:[80,81,82], i:'🌦️', t:'Showers'},
      {codes:[85,86], i:'❄️', t:'Snow showers'},
      {codes:[95], i:'⛈️', t:'Thunderstorm'},
      {codes:[96,99], i:'⛈️', t:'Thunderstorm w/ hail'},
    ];
    function iconFor(code){
      for (const g of WMO_MAP) if (g.codes.includes(code)) return g.i;
      return '❓';
    }
    function hiClass(tempF){
      if (tempF >= 90) return 'hot';
      if (tempF >= 80) return 'warm';
      return 'cool';
    }
    function dowLabel(dateStr){
      const d = new Date(dateStr + 'T12:00:00'); // avoid TZ midnight issues
      return d.toLocaleDateString('en-US', { weekday: 'short', timeZone: TZ });
    }

    async function loadForecast(){
      try{
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}`
          + `&daily=weathercode,temperature_2m_max,temperature_2m_min`
          + `&temperature_unit=${UNITS}&windspeed_unit=${WIND}&timezone=${encodeURIComponent(TZ)}`;
        const res = await fetch(url);
        const data = await res.json();
        const days = data.daily.time.length;

        weatherEl.innerHTML = ''; // clear
        for (let i=0; i<Math.min(7, days); i++){
          const code = data.daily.weathercode[i];
          const hi   = Math.round(data.daily.temperature_2m_max[i]);
          const lo   = Math.round(data.daily.temperature_2m_min[i]);
          const day  = dowLabel(data.daily.time[i]);

          const tile = document.createElement('div');
          tile.className = 'day';
          tile.innerHTML = `
            <div class="dow" title="${day}">${day}</div>
            <div class="icon" title="${code}">${iconFor(code)}</div>
            <div class="hi ${hiClass(hi)}">${hi}°</div>
            <div class="lo">${lo}°</div>
          `;
          weatherEl.appendChild(tile);
        }
      }catch(e){
        weatherEl.innerHTML = '<div style="grid-column:1/-1;display:flex;align-items:center;justify-content:center;font-size:1.2rem;opacity:.8;">Weather unavailable</div>';
        console.error(e);
      }
    }

    loadForecast();
    setInterval(loadForecast, REFRESH_MS);
  </script>
</body>
</html>
