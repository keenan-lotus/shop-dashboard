<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Shop Dashboard ‚Äî Cabinet Jobs + Weather</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    :root{
      --top-split: 80vh;    /* table area height */
      --bottom-split: 20vh; /* weather area height */
      --row-h: 30px;        /* data row height */
      --head-h: 34px;       /* header height */
      --font: 13px;         /* base font */
    }
    html, body { height:100%; margin:0; background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    * { box-sizing: border-box; }
    .wrap { display:grid; grid-template-rows: var(--top-split) var(--bottom-split); height:100vh; width:100vw; }

    /* ===== TABLE ===== */
    #tablePane { overflow:hidden; padding:6px 10px 0 10px; }
    .table{
      width:100%;
      display:grid;
      /* Columns use minmax(min px, fr); this always fits A‚ÄìL into the viewport */
      grid-template-columns:
        minmax(90px,   1.0fr)  /* Status      */
        minmax(110px,  1.1fr)  /* Requester   */
        minmax(100px,  1.0fr)  /* Date Entered*/
        minmax(95px,   0.9fr)  /* Deadline    */
        minmax(120px,  1.1fr)  /* Job Site    */
        minmax(180px,  1.8fr)  /* Part Name   */
        minmax(60px,   0.7fr)  /* Quantity    */
        minmax(110px,  1.1fr)  /* Material    */
        minmax(120px,  1.2fr)  /* Dimensions  */
        minmax(100px,  1.0fr)  /* Shop/Field  */
        minmax(240px,  2.4fr)  /* Notes       */
        minmax(100px,  1.0fr); /* Location    */
      gap:0;
      border:1px solid #202020;
      border-bottom:none;
      background:#0b0b0b;
      font-size:var(--font);
      line-height:1;
    }
    .th,.td{
      border-bottom:1px solid #202020;
      border-right:1px solid #202020;
      padding:6px 8px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      display:flex; align-items:center;
      height:var(--row-h);
    }
    .th{ height:var(--head-h); font-weight:700; background:#141414; position:sticky; top:0; z-index:2; }
    .td:last-child,.th:last-child{ border-right:none; }
    .pill{ padding:3px 8px; border-radius:999px; font-weight:600; }
    .pill.inprogress{ background:#3a2a00; color:#ffb84d; }
    .pill.completed { background:#123016; color:#7dffa1; }
    .align-right{ justify-content:flex-end; }
    .muted{ opacity:.85; }
    .deadline-soon{ color:#ffb84d; }
    .deadline-over{ color:#ff6666; }
    #metaBar{ display:flex; justify-content:space-between; align-items:center; height:20px; padding:0 8px; font-size:12px; color:#bdbdbd; }

    /* ===== WEATHER ===== */
    #weather{ background:#0b0b0b; display:grid; grid-template-columns:repeat(7, 1fr); gap:0; }
    .day{ display:grid; grid-template-rows:.5fr 1.1fr .8fr .6fr; align-items:center; justify-items:center; border-left:1px solid rgba(255,255,255,.08); }
    .day:first-child{ border-left:none; }
    .dow{ font-size:.95rem; opacity:.9; margin-top:2px; }
    .icon{ font-size:1.8rem; line-height:1; }
    .hi{ font-size:1.2rem; font-weight:700; }
    .lo{ font-size:.95rem; opacity:.9; margin-bottom:4px; }
    .hi.hot{ color:#ff6b6b; }
    .hi.warm{ color:#ffa94d; }
    .hi.cool{ color:#4dabf7; }
    ::-webkit-scrollbar{ width:0; height:0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="tablePane">
      <div id="table" class="table" role="table" aria-label="Cabinet Jobs"></div>
      <div id="metaBar"><span id="lastUpdated"></span><span id="pageInfo"></span></div>
    </div>
    <div id="weather" aria-label="7-day weather for Nashville, TN"></div>
  </div>

  <script>
    /* ===== CONFIG: your published CSV link for "Cabinet Jobs" ===== */
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjgGLB8JhGMcUzYI5H8VErNy-ZSEPu7CvPygo30HEPe4HnyjsAPxsKQZnOz_0e5AeDxXW5Ea8JAxFv/pub?gid=0&single=true&output=csv";

    const REFRESH_MS = 5*60*1000;
    const PAGE_DWELL_MS = 12000;
    const TIMEZONE = "America/Chicago";

    /* Only show rows actively being worked */
    const SHOW_ONLY_IN_PROGRESS = true;

    const COLS = [
      { key:'status',      label:'Status',       class:'status' },
      { key:'requester',   label:'Requester' },
      { key:'dateentered', label:'Date Entered' },
      { key:'deadline',    label:'Deadline',     class:'deadline' },
      { key:'jobsite',     label:'Job Site' },
      { key:'partname',    label:'Part Name' },
      { key:'quantity',    label:'Quantity',     class:'align-right' },
      { key:'material',    label:'Material' },
      { key:'dimensions',  label:'Dimensions' },
      { key:'shopfield',   label:'Shop/Field' },
      { key:'notes',       label:'Notes' },
      { key:'location',    label:'Location' },
    ];

    let rowsAll = [];
    let page = 0, rowsPerPage = 1;

    const norm = s => String(s||'').toLowerCase().replace(/[^a-z0-9]/g,'');

    function parseCSV(text){
      const out=[]; let row=[]; let i=0; let cur=''; let inQ=false;
      while(i<text.length){
        const ch=text[i++];
        if(inQ){
          if(ch==='"'){ if(text[i]==='"'){cur+='"'; i++;} else inQ=false; }
          else cur+=ch;
        }else{
          if(ch==='"') inQ=true;
          else if(ch===','){ row.push(cur); cur=''; }
          else if(ch==='\n'){ row.push(cur); out.push(row); row=[]; cur=''; }
          else if(ch!=='\r') cur+=ch;
        }
      }
      if(cur.length||row.length){ row.push(cur); out.push(row); }
      return out;
    }

    async function loadCSV(){
      const res = await fetch(CSV_URL, {cache:'no-cache'});
      const text = await res.text();
      const grid = parseCSV(text);
      if(!grid.length) return;

      const head = grid[0].map(h => norm(h));
      const mapIdx = COLS.map(c => head.indexOf(c.key));

      const data=[];
      for(let r=1;r<grid.length;r++){
        const raw = grid[r];
        const obj={}; let empty=true;
        for(let c=0;c<COLS.length;c++){
          const idx = mapIdx[c];
          const val = idx>=0 ? raw[idx] : '';
          if(val!=='' && val!=null) empty=false;
          obj[COLS[c].key] = val;
        }
        if(!empty) data.push(obj);
      }

      // Optional filter to in-progress only
      rowsAll = SHOW_ONLY_IN_PROGRESS ? data.filter(d => norm(d.status)==='inprogress') : data;

      computeRowsPerPage();
      page=0;
      renderPage();
      document.getElementById('lastUpdated').textContent =
        'Last updated: ' + new Date().toLocaleString('en-US',{timeZone:TIMEZONE});
    }

    function computeRowsPerPage(){
      const pane = document.getElementById('tablePane');
      const cs = getComputedStyle(document.documentElement);
      const headerH = parseInt(cs.getPropertyValue('--head-h'))||34;
      const rowH    = parseInt(cs.getPropertyValue('--row-h')) ||30;
      const metaH   = 20;
      const paneH   = Math.max(120, pane.getBoundingClientRect().height);
      rowsPerPage = Math.max(1, Math.floor((paneH - headerH - metaH) / rowH));
    }

    function deadlineClass(s){
      if(!s) return '';
      const d=new Date(s); if(isNaN(d)) return '';
      const t=new Date(); t.setHours(0,0,0,0);
      const dl=new Date(d); dl.setHours(0,0,0,0);
      const diff=Math.round((dl-t)/86400000);
      if(diff<0) return 'deadline-over';
      if(diff<=2) return 'deadline-soon';
      return '';
    }

    function statusPill(s){
      const v = norm(s);
      if(v==='completed') return '<span class="pill completed">Completed</span>';
      if(v==='inprogress') return '<span class="pill inprogress">In&nbsp;Progress</span>';
      return `<span class="muted">${s||''}</span>`;
    }

    function renderPage(){
      const table=document.getElementById('table');
      table.innerHTML='';

      // header
      for(const c of COLS){
        const el=document.createElement('div');
        el.className='th';
        el.textContent=c.label;
        table.appendChild(el);
      }

      const start = page*rowsPerPage;
      const end = Math.min(start+rowsPerPage, rowsAll.length);

      // actual rows
      for(let r=start;r<end;r++){
        const row=rowsAll[r];
        for(const c of COLS){
          const el=document.createElement('div');
          const cl=['td']; if(c.class) cl.push(c.class);
          if(c.key==='status') el.innerHTML=statusPill(row[c.key]);
          else if(c.key==='deadline'){ el.textContent=row[c.key]; el.classList.add(deadlineClass(row[c.key])); }
          else el.textContent=row[c.key];
          el.className=cl.join(' ');
          table.appendChild(el);
        }
      }

      // filler rows (so no black gap)
      const fillers = Math.max(0, rowsPerPage - (end - start));
      for(let i=0;i<fillers;i++){
        for(const c of COLS){
          const el=document.createElement('div');
          el.className='td muted';
          el.textContent='';
          table.appendChild(el);
        }
      }

      const pInfo=document.getElementById('pageInfo');
      const totalPages=Math.max(1, Math.ceil(rowsAll.length/rowsPerPage));
      pInfo.textContent=`Rows ${start+1}‚Äì${end} of ${rowsAll.length}  ‚Ä¢  Page ${page+1}/${totalPages}`;
    }

    window.addEventListener('resize', ()=>{ computeRowsPerPage(); page=0; renderPage(); });
    setInterval(()=>{ if(!rowsAll.length) return; const total=Math.max(1, Math.ceil(rowsAll.length/rowsPerPage)); page=(page+1)%total; renderPage(); }, PAGE_DWELL_MS);
    setInterval(loadCSV, REFRESH_MS);
    loadCSV();

    /* ===== WEATHER (Open-Meteo 7-Day) ===== */
    const LAT=36.1627, LON=-86.7816, TZ='America/Chicago';
    const WMO=[
      {codes:[0],i:'‚òÄÔ∏è'},{codes:[1,2],i:'üå§Ô∏è'},{codes:[3],i:'‚òÅÔ∏è'},
      {codes:[45,48],i:'üå´Ô∏è'},{codes:[51,53,55],i:'üå¶Ô∏è'},{codes:[56,57],i:'üåßÔ∏è'},
      {codes:[61,63,65],i:'üåßÔ∏è'},{codes:[66,67],i:'üåßÔ∏è'},{codes:[71,73,75,77],i:'‚ùÑÔ∏è'},
      {codes:[80,81,82],i:'üå¶Ô∏è'},{codes:[85,86],i:'‚ùÑÔ∏è'},{codes:[95],i:'‚õàÔ∏è'},{codes:[96,99],i:'‚õàÔ∏è'}
    ];
    const ico = code => (WMO.find(g=>g.codes.includes(code))||{i:'‚ùì'}).i;
    const hiCls = f => f>=90?'hot':f>=80?'warm':'cool';
    const dow = d => new Date(d+'T12:00:00').toLocaleDateString('en-US',{weekday:'short', timeZone:TZ});

    async function loadWx(){
      try{
        const url=`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&daily=weathercode,temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&windspeed_unit=mph&timezone=${encodeURIComponent(TZ)}`;
        const res=await fetch(url); const data=await res.json();
        const W=document.getElementById('weather'); W.innerHTML='';
        for(let i=0;i<7;i++){
          const d=document.createElement('div'); d.className='day';
          const hi=Math.round(data.daily.temperature_2m_max[i]);
          const lo=Math.round(data.daily.temperature_2m_min[i]);
          d.innerHTML=`<div class="dow">${dow(data.daily.time[i])}</div>
                       <div class="icon">${ico(data.daily.weathercode[i])}</div>
                       <div class="hi ${hiCls(hi)}">${hi}¬∞</div>
                       <div class="lo">${lo}¬∞</div>`;
          W.appendChild(d);
        }
      }catch(e){ console.error(e); }
    }
    loadWx(); setInterval(loadWx, 30*60*1000);
  </script>
</body>
</html>
