<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Shop Dashboard â€” Nashville</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* Adjust the split here if you want more/less weather space */
      --top-percent: 75vh;   /* top area height (sheet/slides) */
      --bottom-percent: calc(100vh - var(--top-percent)); /* weather auto-fills rest */
    }
    html, body { height: 100%; margin: 0; background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { height: 100vh; width: 100vw; display: grid; grid-template-rows: var(--top-percent) var(--bottom-percent); }

    /* TOP container holds two panes, we toggle them */
    #sheetBox { position: relative; background:#000; overflow:hidden; }
    .pane { position:absolute; inset:0; }
    .hidden { display:none; }

    /* Iframes */
    iframe { border:0; width:100%; height:100%; background:#000; }

    /* BOTTOM: Custom 7-day forecast */
    #weather { background:#0b0b0b; height:100%; width:100%; display:grid; grid-template-columns: repeat(7, 1fr); gap:0; }
    .day {
      display:grid; grid-template-rows: 1.2fr 0.8fr 0.6fr; /* icon / hi / lo */
      align-items:center; justify-items:center; height:100%;
      border-left: 1px solid rgba(255,255,255,0.08);
    }
    .day:first-child { border-left:none; }
    .dow { font-size: 0.95rem; opacity: 0.9; margin-top: 2px; }
    .icon { font-size: 1.8rem; line-height: 1; }
    .hi   { font-size: 1.2rem; font-weight: 700; }
    .lo   { font-size: 0.95rem; opacity: 0.9; margin-bottom: 4px; }

    /* color the high temp bar subtly; redder when hotter */
    .hi.hot    { color:#ff6b6b; }   /* 90+ */
    .hi.warm   { color:#ffa94d; }   /* 80-89 */
    .hi.cool   { color:#4dabf7; }   /* below 80 */

    /* Hide page scrollbars for a cleaner TV look */
    ::-webkit-scrollbar { width:0; height:0; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- TOP: Sheet pane + Slides pane (we rotate them) -->
    <div id="sheetBox">
      <!-- Sheet pane (your existing embed) -->
      <div id="paneSheet" class="pane">
        <iframe
          id="sheet"
          src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSBrgvQHdcw5mVUfRSSewO0BQ3pNcbL2WAAb5WshzX1LVv0Ht2TVnMSyp5WME5oiTvBrsrVN2wtrfE8/pubhtml?gid=0&single=true">
        </iframe>
      </div>

      <!-- Slides pane (hidden by default) -->
      <div id="paneSlides" class="pane hidden">
        <!-- Use your Google Slides "Publish to the web â†’ Link" here -->
        <iframe id="slides" allow="autoplay"></iframe>
      </div>
    </div>

    <!-- BOTTOM: Native 7-day forecast (Open-Meteo) -->
    <div id="weather" aria-label="7-day weather for Nashville, TN"></div>
  </div>

  <script>
    /******** CONFIG ********/
    // 1) Google Slides (Publish to web â†’ Link). Example ends like:
    //    .../pub?start=true&loop=true&delayms=10000
    const SLIDES_URL = "PASTE_YOUR_PUBLISHED_SLIDES_LINK_HERE";

    // 2) Rotation timing
    const ROTATE_MS = 45 * 1000;        // show Sheet 45s, Slides 45s, repeat

    // 3) Optional: refresh the Sheet iframe every 5 minutes to keep it fresh
    const SHEET_REFRESH_MS = 5 * 60 * 1000;

    /******** SHEET/SLIDES ROTATION ********/
    const paneSheet  = document.getElementById('paneSheet');
    const paneSlides = document.getElementById('paneSlides');
    const sheetIF    = document.getElementById('sheet');
    const slidesIF   = document.getElementById('slides');

    function showSheet(){
      // Stop slides to save CPU on Fire TV
      slidesIF.src = 'about:blank';
      paneSlides.classList.add('hidden');
      paneSheet.classList.remove('hidden');
    }
    function showSlides(){
      paneSheet.classList.add('hidden');
      paneSlides.classList.remove('hidden');
      // Force reload with cache-busting param so autoplay/loop kicks in on Silk
      const ts = Date.now();
      const sep = SLIDES_URL.includes('?') ? '&' : '?';
      slidesIF.src = SLIDES_URL + sep + 'ts=' + ts;
    }

    // Start on the Sheet (current behavior), then toggle every ROTATE_MS
    showSheet();
    setInterval(() => {
      if (paneSlides.classList.contains('hidden')) showSlides();
      else showSheet();
    }, ROTATE_MS);

    // Keep the sheet refreshed in the background (optional)
    if (SHEET_REFRESH_MS > 0) {
      setInterval(() => { sheetIF.src = sheetIF.src; }, SHEET_REFRESH_MS);
    }

    /******** WEATHER: Nashville via Open-Meteo (no API key) ********/
    const LAT = 36.1627, LON = -86.7816, TZ = 'America/Chicago';
    const UNITS = 'fahrenheit'; // 'fahrenheit' or 'celsius'
    const WIND  = 'mph';        // mph, kmh, ms, kn
    const REFRESH_MS = 30 * 60 * 1000; // re-fetch every 30 min

    const weatherEl = document.getElementById('weather');

    const WMO_MAP = [
      {codes:[0], i:'â˜€ï¸', t:'Clear'},
      {codes:[1,2], i:'ðŸŒ¤ï¸', t:'Partly cloudy'},
      {codes:[3], i:'â˜ï¸', t:'Overcast'},
      {codes:[45,48], i:'ðŸŒ«ï¸', t:'Fog'},
      {codes:[51,53,55], i:'ðŸŒ¦ï¸', t:'Drizzle'},
      {codes:[56,57], i:'ðŸŒ§ï¸', t:'Freezing drizzle'},
      {codes:[61,63,65], i:'ðŸŒ§ï¸', t:'Rain'},
      {codes:[66,67], i:'ðŸŒ§ï¸', t:'Freezing rain'},
      {codes:[71,73,75,77], i:'â„ï¸', t:'Snow'},
      {codes:[80,81,82], i:'ðŸŒ¦ï¸', t:'Showers'},
      {codes:[85,86], i:'â„ï¸', t:'Snow showers'},
      {codes:[95], i:'â›ˆï¸', t:'Thunderstorm'},
      {codes:[96,99], i:'â›ˆï¸', t:'Thunderstorm w/ hail'},
    ];
    function iconFor(code){
      for (const g of WMO_MAP) if (g.codes.includes(code)) return g.i;
      return 'â“';
    }
    function hiClass(tempF){
      if (tempF >= 90) return 'hot';
      if (tempF >= 80) return 'warm';
      return 'cool';
    }
    function dowLabel(dateStr){
      const d = new Date(dateStr + 'T12:00:00'); // avoid TZ midnight issues
      return d.toLocaleDateString('en-US', { weekday: 'short', timeZone: TZ });
    }

    async function loadForecast(){
      try{
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}`
          + `&daily=weathercode,temperature_2m_max,temperature_2m_min`
          + `&temperature_unit=${UNITS}&windspeed_unit=${WIND}&timezone=${encodeURIComponent(TZ)}`;
        const res = await fetch(url);
        const data = await res.json();
        const days = data.daily.time.length;

        weatherEl.innerHTML = ''; // clear
        for (let i=0; i<Math.min(7, days); i++){
          const code = data.daily.weathercode[i];
          const hi   = Math.round(data.daily.temperature_2m_max[i]);
          const lo   = Math.round(data.daily.temperature_2m_min[i]);
          const day  = dowLabel(data.daily.time[i]);

          const tile = document.createElement('div');
          tile.className = 'day';
          tile.innerHTML = `
            <div class="dow" title="${day}">${day}</div>
            <div class="icon" title="${code}">${iconFor(code)}</div>
            <div class="hi ${hiClass(hi)}">${hi}Â°</div>
            <div class="lo">${lo}Â°</div>
          `;
          // Use 4 rows: tiny DOW at top, then icon, hi, lo
          tile.style.gridTemplateRows = '0.5fr 1.1fr 0.8fr 0.6fr';
          weatherEl.appendChild(tile);
        }
      }catch(e){
        weatherEl.innerHTML = '<div style="grid-column:1/-1;display:flex;align-items:center;justify-content:center;font-size:1.2rem;opacity:.8;">Weather unavailable</div>';
        console.error(e);
      }
    }

    loadForecast();
    setInterval(loadForecast, REFRESH_MS);
  </script>
</body>
</html>
