<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Shop Dashboard â€” Cabinet Jobs + Weather</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    :root{
      /* Layout */
      --top-split: 80vh;       /* table area height */
      --bottom-split: 20vh;    /* weather area height */
      /* Table sizing (tight for TV density) */
      --row-h: 30px;           /* data row height */
      --head-h: 34px;          /* header height */
      --font: 13px;            /* base font size */
    }

    html, body { height: 100%; margin: 0; background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    * { box-sizing: border-box; }
    .wrap { display: grid; grid-template-rows: var(--top-split) var(--bottom-split); height: 100vh; width: 100vw; }

    /* ===== TABLE ===== */
    #tablePane { overflow: hidden; padding: 6px 10px 0 10px; }
    .table {
      width: 100%;
      display: grid;
      /* gridTemplateColumns is set dynamically in JS to fit viewport */
      gap: 0;
      border: 1px solid #202020;
      border-bottom: none;
      background:#0b0b0b;
      font-size: var(--font);
      line-height: 1;
    }
    .th, .td {
      border-bottom: 1px solid #202020;
      border-right: 1px solid #202020;
      padding: 6px 8px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      display: flex; align-items: center;
      height: var(--row-h);
    }
    .th { height: var(--head-h); font-weight: 700; background:#141414; position: sticky; top: 0; z-index: 2; }
    .td:last-child, .th:last-child { border-right: none; }

    .row:nth-child(even) .td { background:#0f0f0f; }
    .row:nth-child(odd)  .td { background:#0b0b0b; }

    .pill { padding: 3px 8px; border-radius: 999px; font-weight: 600; }
    .pill.inprogress { background:#3a2a00; color:#ffb84d; }
    .pill.completed  { background:#123016; color:#7dffa1; }

    .align-right { justify-content: flex-end; }
    .muted { opacity: 0.85; }

    .deadline-soon { color:#ffb84d; }   /* within 2 days */
    .deadline-over { color:#ff6666; }   /* overdue */

    #metaBar { display:flex; justify-content:space-between; align-items:center; height: 20px; padding: 0 8px; font-size: 12px; color:#bdbdbd; }

    /* ===== WEATHER ===== */
    #weather { background:#0b0b0b; display:grid; grid-template-columns: repeat(7, 1fr); gap:0; }
    .day {
      display:grid; grid-template-rows: 0.5fr 1.1fr 0.8fr 0.6fr;
      align-items:center; justify-items:center;
      border-left: 1px solid rgba(255,255,255,0.08);
    }
    .day:first-child { border-left:none; }
    .dow { font-size: 0.95rem; opacity: 0.9; margin-top: 2px; }
    .icon { font-size: 1.8rem; line-height: 1; }
    .hi   { font-size: 1.2rem; font-weight: 700; }
    .lo   { font-size: 0.95rem; opacity: 0.9; margin-bottom: 4px; }
    .hi.hot  { color:#ff6b6b; }   /* 90+ */
    .hi.warm { color:#ffa94d; }   /* 80-89 */
    .hi.cool { color:#4dabf7; }   /* <80 */

    /* Hide scrollbars */
    ::-webkit-scrollbar { width:0; height:0; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- TOP: Jobs table -->
    <div id="tablePane">
      <div id="table" class="table" role="table" aria-label="Cabinet Jobs"></div>
      <div id="metaBar"><span id="lastUpdated"></span><span id="pageInfo"></span></div>
    </div>

    <!-- BOTTOM: Weather -->
    <div id="weather" aria-label="7-day weather for Nashville, TN"></div>
  </div>

  <script>
    /*************** CONFIG: paste YOUR published CSV link for "Cabinet Jobs" below ***************/
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjgGLB8JhGMcUzYI5H8VErNy-ZSEPu7CvPygo30HEPe4HnyjsAPxsKQZnOz_0e5AeDxXW5Ea8JAxFv/pub?gid=0&single=true&output=csv";

    const REFRESH_MS = 5 * 60 * 1000;      // re-fetch sheet every 5 min
    const PAGE_DWELL_MS = 12000;           // dwell per page (ms)
    const TIMEZONE = "America/Chicago";

    // Define columns with BASE pixel widths; JS scales them to fit viewport width.
    const COLS = [
      { key:'status',      label:'Status',       w:  90, class:'status' },
      { key:'requester',   label:'Requester',    w: 120 },
      { key:'dateentered', label:'Date Entered', w: 100 },
      { key:'deadline',    label:'Deadline',     w: 100, class:'deadline' },
      { key:'jobsite',     label:'Job Site',     w: 140 },
      { key:'partname',    label:'Part Name',    w: 200 },
      { key:'quantity',    label:'Quantity',     w:  70, class:'align-right' },
      { key:'material',    label:'Material',     w: 120 },
      { key:'dimensions',  label:'Dimensions',   w: 140 },
      { key:'shopfield',   label:'Shop/Field',   w: 110 },
      { key:'notes',       label:'Notes',        w: 420 },
      { key:'location',    label:'Location',     w: 110 },
    ];
    const TOTAL_BASE_W = COLS.reduce((s,c)=>s+c.w,0); // ~1720px

    // ===== CSV fetch & render =====
    let rowsAll = [];
    let page = 0, rowsPerPage = 1;

    function norm(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]/g,''); }

    function parseCSV(text){
      const out = []; let row = []; let i = 0; let cur = ''; let inQ = false;
      while (i < text.length){
        const ch = text[i++];
        if (inQ){
          if (ch === '"'){
            if (text[i] === '"'){ cur += '"'; i++; } else { inQ = false; }
          } else cur += ch;
        } else {
          if (ch === '"'){ inQ = true; }
          else if (ch === ','){ row.push(cur); cur=''; }
          else if (ch === '\n'){ row.push(cur); out.push(row); row=[]; cur=''; }
          else if (ch === '\r'){ /* ignore */ }
          else cur += ch;
        }
      }
      if (cur.length || row.length) { row.push(cur); out.push(row); }
      return out;
    }

    async function loadCSV(){
      try{
        const res = await fetch(CSV_URL, {cache:'no-cache'});
        const text = await res.text();
        const grid = parseCSV(text);
        if (!grid.length) return;

        const head = grid[0].map(h => norm(h));
        const mapIdx = COLS.map(c => head.indexOf(c.key));

        const data = [];
        for (let r=1; r<grid.length; r++){
          const raw = grid[r];
          const obj = {};
          let empty = true;
          for (let c=0; c<COLS.length; c++){
            const idx = mapIdx[c];
            const val = idx >= 0 ? raw[idx] : '';
            if (val !== '' && val != null) empty = false;
            obj[COLS[c].key] = val;
          }
          if (!empty) data.push(obj);
        }

        rowsAll = data;
        computeRowsPerPage();
        page = 0;
        renderPage();
        document.getElementById('lastUpdated').textContent =
          'Last updated: ' + new Date().toLocaleString('en-US', { timeZone: TIMEZONE });
      }catch(e){
        console.error(e);
      }
    }

    function computeRowsPerPage(){
      const pane = document.getElementById('tablePane');
      const cs = getComputedStyle(document.documentElement);
      const headerH = parseInt(cs.getPropertyValue('--head-h')) || 34;
      const rowH    = parseInt(cs.getPropertyValue('--row-h'))  || 30;
      const metaH   = 20; // meta bar
      const paneH   = Math.max(120, pane.getBoundingClientRect().height);
      rowsPerPage = Math.max(1, Math.floor((paneH - headerH - metaH) / rowH));
    }

    // Compute scaled column widths to exactly fit the available width.
    function applyGridWidths(table){
      const paneW = Math.floor(document.getElementById('tablePane').clientWidth) - 2; // borders
      const scale = Math.min(1, paneW / TOTAL_BASE_W);
      const cols = COLS.map(c => Math.floor(c.w * scale) + 'px').join(' ');
      table.style.gridTemplateColumns = cols;

      // If scale is quite small, gently reduce font a notch for readability.
      document.documentElement.style.setProperty('--font', (scale < 0.9 ? 12 : 13) + 'px');
    }

    function deadlineClass(deadlineStr){
      if (!deadlineStr) return '';
      const d = new Date(deadlineStr);
      if (isNaN(d)) return '';
      const today = new Date(); today.setHours(0,0,0,0);
      const ddl = new Date(d);  ddl.setHours(0,0,0,0);
      const diffDays = Math.round((ddl - today) / 86400000);
      if (diffDays < 0) return 'deadline-over';
      if (diffDays <= 2) return 'deadline-soon';
      return '';
    }

    function statusPill(s){
      const val = norm(s);
      if (val === 'completed') return '<span class="pill completed">Completed</span>';
      if (val === 'inprogress') return '<span class="pill inprogress">In&nbsp;Progress</span>';
      return `<span class="muted">${s||''}</span>`;
    }

    function renderPage(){
      const table = document.getElementById('table');
      table.innerHTML = '';
      applyGridWidths(table);

      // header
      for (const c of COLS){
        const el = document.createElement('div');
        el.className = 'th';
        el.textContent = c.label;
        table.appendChild(el);
      }

      const start = page * rowsPerPage;
      const end = Math.min(start + rowsPerPage, rowsAll.length);
      for (let r=start; r<end; r++){
        const row = rowsAll[r];
        for (const c of COLS){
          const el = document.createElement('div');
          const cl = ['td']; if (c.class) cl.push(c.class);
          if (c.key === 'status') { el.innerHTML = statusPill(row[c.key]); }
          else if (c.key === 'deadline') { el.textContent = row[c.key]; el.classList.add(deadlineClass(row[c.key])); }
          else { el.textContent = row[c.key]; }
          el.className = cl.join(' ');
          table.appendChild(el);
        }
      }

      const pInfo = document.getElementById('pageInfo');
      const totalPages = Math.max(1, Math.ceil(rowsAll.length / rowsPerPage));
      pInfo.textContent = `Rows ${start+1}â€“${end} of ${rowsAll.length}  â€¢  Page ${page+1}/${totalPages}`;
    }

    window.addEventListener('resize', () => { computeRowsPerPage(); page = 0; renderPage(); });

    // paging loop
    setInterval(() => {
      if (!rowsAll.length) return;
      const total = Math.max(1, Math.ceil(rowsAll.length / rowsPerPage));
      page = (page + 1) % total;
      renderPage();
    }, PAGE_DWELL_MS);

    // refresh data periodically
    setInterval(loadCSV, REFRESH_MS);

    // initial load
    loadCSV();

    /*************** WEATHER (Open-Meteo 7-Day) ***************/
    const LAT = 36.1627, LON = -86.7816, TZ = 'America/Chicago';
    const UNITS = 'fahrenheit'; const WIND  = 'mph';
    const WMO = [
      {codes:[0], i:'â˜€ï¸'},{codes:[1,2], i:'ðŸŒ¤ï¸'},{codes:[3], i:'â˜ï¸'},
      {codes:[45,48], i:'ðŸŒ«ï¸'},{codes:[51,53,55], i:'ðŸŒ¦ï¸'},{codes:[56,57], i:'ðŸŒ§ï¸'},
      {codes:[61,63,65], i:'ðŸŒ§ï¸'},{codes:[66,67], i:'ðŸŒ§ï¸'},{codes:[71,73,75,77], i:'â„ï¸'},
      {codes:[80,81,82], i:'ðŸŒ¦ï¸'},{codes:[85,86], i:'â„ï¸'},{codes:[95], i:'â›ˆï¸'},{codes:[96,99], i:'â›ˆï¸'}
    ];
    function ico(code){ for (const g of WMO) if (g.codes.includes(code)) return g.i; return 'â“'; }
    function hiCls(f){ return f>=90 ? 'hot' : f>=80 ? 'warm' : 'cool'; }
    function dow(d){ return new Date(d+'T12:00:00').toLocaleDateString('en-US',{weekday:'short', timeZone:TZ}); }

    async function loadWx(){
      try{
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}`
          + `&daily=weathercode,temperature_2m_max,temperature_2m_min&temperature_unit=${UNITS}`
          + `&windspeed_unit=${WIND}&timezone=${encodeURIComponent(TZ)}`;
        const res = await fetch(url); const data = await res.json();
        const W = document.getElementById('weather'); W.innerHTML='';
        for (let i=0; i<7; i++){
          const d = document.createElement('div'); d.className='day';
          const hi = Math.round(data.daily.temperature_2m_max[i]);
          const lo = Math.round(data.daily.temperature_2m_min[i]);
          d.innerHTML = `
            <div class="dow">${dow(data.daily.time[i])}</div>
            <div class="icon">${ico(data.daily.weathercode[i])}</div>
            <div class="hi ${hiCls(hi)}">${hi}Â°</div>
            <div class="lo">${lo}Â°</div>`;
          W.appendChild(d);
        }
      }catch(e){ console.error(e); }
    }
    loadWx(); setInterval(loadWx, 30*60*1000);
  </script>
</body>
</html>
